# Generated by script. Don't change it manually!

FROM node:bookworm-slim

ENV NVIM_USER=node
ENV MNT_DIR=/mnt/project
ENV HOME=/home/$NVIM_USER
ENV XDG_CONFIG_HOME=$HOME/.local/share
ENV NPM_CONFIG_PREFIX=$HOME/.npm-global
ENV COC_PATH=$XDG_CONFIG_HOME/coc
ENV NVIM_CONF_PATH=$XDG_CONFIG_HOME/nvim
ENV COC_SETTINGS_PATH=$NVIM_CONF_PATH/coc-settings.json
ENV EXTENSIONS=$COC_PATH/extensions

RUN mkdir -p $MNT_DIR
RUN apt-get update && apt-get install sudo git -y
RUN apt-get install ninja-build gettext cmake unzip curl build-essential -y

#RUN curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim.appimage \
#       && chmod u+x nvim.appimage \
#       && ./nvim.appimage --appimage-extract \
#       && ln -s /squashfs-root/AppRun /usr/bin/nvim

WORKDIR /root
RUN git clone https://github.com/neovim/neovim.git
WORKDIR /root/neovim
RUN git checkout stable
RUN make CMAKE_BUILD_TYPE=RelWithDebInfo
RUN make install

RUN usermod -aG sudo $NVIM_USER
RUN echo "$NVIM_USER ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/$NVIM_USER


RUN mkdir -p $HOME
RUN chown $NVIM_USER:$NVIM_USER -R $HOME
RUN mkdir -p $COC_PATH
RUN chown node:node -R $COC_PATH
COPY coc-settings.json $COC_SETTINGS_PATH
RUN chown $NVIM_USER:$NVIM_USER $COC_SETTINGS_PATH
RUN mkdir -p $NVIM_CONF_PATH/site/autoload
RUN chown $NVIM_USER:$NVIM_USER -R $NVIM_CONF_PATH

RUN chown root:root /usr/bin/sudo
RUN chmod 4755 /usr/bin/sudo

USER $NVIM_USER
WORKDIR $HOME


RUN mkdir -p $EXTENSIONS
RUN echo '{"dependencies":{}}' > $EXTENSIONS/package.json
ENV PATH=$PATH:$EXTENSIONS/node_modules/.bin

RUN sh -c 'curl -fLo $HOME/.local/share/nvim/site/autoload/plug.vim \
       https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
COPY init.vim $XDG_CONFIG_HOME/nvim/init.vim
RUN nvim -c "PlugInstall --sync | qa"

RUN sudo apt-get remove ninja-build gettext cmake unzip build-essential git -y
RUN sudo apt-get autoremove -y
########## Platform specified part ##########


RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH=/home/$NVIM_USER/.cargo/bin:$PATH

RUN rustup component add rust-analyzer

WORKDIR $EXTENSIONS
RUN npm install coc-rust-analyzer --ignore-scripts --no-lockfile --no-global --legacy-peer-deps --omit=dev
#############################################


COPY init.sh $HOME/init.sh
COPY entrypoint.sh $HOME/entrypoint.sh

RUN sudo chown $NVIM_USER:$NVIM_USER $HOME/*

ENV PATH=$PATH:$NPM_CONFIG_PREFIX/bin

WORKDIR $MNT_DIR

ENTRYPOINT ["sh", "/home/node/entrypoint.sh"]
CMD ["sh", "/home/node/init.sh"]
